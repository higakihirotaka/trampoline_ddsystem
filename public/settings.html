<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大会設定 - Trampoline System</title>
    <style>
        :root { --primary: #263238; --accent: #1a73e8; --danger: #d32f2f; --bg: #f0f2f5; --card: #ffffff; --text-main: #263238; --text-sub: #546e7a; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-main); }
        .container { max-width: 800px; margin: 0 auto; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .btn-back { text-decoration: none; color: var(--text-sub); font-size: 0.9rem; border: 1px solid #ccc; padding: 8px 20px; border-radius: 8px; }
        .auth-info { font-size: 0.85em; color: #999; display: none; align-items: center; }
        .auth-info span { font-weight: bold; color: var(--text-main); }
        .logout-btn { background: none; border: 1px solid #ccc; border-radius: 5px; color: var(--accent); cursor: pointer; font-size: 0.9em; margin-left: 12px; padding: 3px 8px; }
        .card { background: var(--card); border-radius: 16px; padding: 28px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        h2 { font-size: 1.1rem; font-weight: 900; margin: 0 0 20px; border-left: 5px solid var(--accent); padding-left: 14px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-size: 0.78rem; font-weight: bold; color: var(--text-sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input[type="text"], input[type="date"] { width: 100%; padding: 10px 14px; border: 1px solid #d0d7de; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #f8fbff; transition: border-color 0.2s; }
        input[type="text"]:focus, input[type="date"]:focus { border-color: var(--accent); outline: none; background: #fff; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .btn-save { background: var(--accent); color: white; display: block; width: 100%; padding: 12px; margin-top: 8px; font-size: 1rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-save:hover { background: #1557b0; }
        .btn-save:disabled { background: #b0bec5; cursor: not-allowed; }
        .class-list { margin-bottom: 12px; }
        .class-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: #f8fbff; border: 1px solid #e0e7ef; border-radius: 10px; margin-bottom: 8px; }
        .class-item input { flex: 1; border: 1px solid #d0d7de; border-radius: 6px; padding: 7px 10px; font-size: 0.95rem; background: white; }
        .class-item input:focus { border-color: var(--accent); outline: none; }
        .btn-icon { background: none; border: 1px solid #d0d7de; border-radius: 6px; padding: 5px 9px; cursor: pointer; font-size: 0.9rem; color: var(--text-sub); transition: background 0.15s; flex-shrink: 0; }
        .btn-icon:hover:not(:disabled) { background: #f1f3f4; }
        .btn-icon:disabled { opacity: 0.3; cursor: default; }
        .btn-icon.danger { color: var(--danger); border-color: #ffcdd2; }
        .btn-icon.danger:hover { background: #ffebee; }
        .btn-add { display: flex; align-items: center; justify-content: center; gap: 6px; background: none; border: 2px dashed #b0bec5; border-radius: 10px; width: 100%; padding: 10px; color: var(--text-sub); font-size: 0.95rem; cursor: pointer; transition: all 0.2s; box-sizing: border-box; }
        .btn-add:hover { border-color: var(--accent); color: var(--accent); background: #f0f7ff; }
        .type-section { }
        .type-header { margin-bottom: 10px; }
        .type-badge { display: inline-block; font-size: 0.78rem; font-weight: 900; padding: 3px 12px; border-radius: 12px; letter-spacing: 0.5px; text-transform: uppercase; }
        .type-badge.individual { background: #e3f2fd; color: #1565c0; }
        .type-badge.synchro { background: #e8f5e9; color: #2e7d32; }
        .danger-zone { background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 16px; padding: 28px; }
        .danger-zone h2 { border-left-color: var(--danger); }
        .danger-zone p { color: #c62828; font-size: 0.9rem; margin: 0 0 16px; }
        .btn-danger { background: var(--danger); color: white; padding: 10px 24px; border-radius: 8px; border: none; font-size: 0.95rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .btn-danger:hover { background: #b71c1c; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #263238; color: white; padding: 12px 28px; border-radius: 30px; font-size: 0.95rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; white-space: nowrap; }
        .toast.show { opacity: 1; }
        .toast.error { background: var(--danger); }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header-bar">
        <a href="#" id="back-link" class="btn-back">← 管理メニューに戻る</a>
        <div id="auth-info" class="auth-info">
            <span id="user-name"></span>としてログイン中
            <button id="logout-btn" class="logout-btn">ログアウト</button>
        </div>
    </div>

    <div class="card">
        <h2>基本情報</h2>
        <div class="form-group">
            <label>大会名</label>
            <input type="text" id="name" placeholder="例：第○回トランポリン競技会">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>開始日</label>
                <input type="date" id="start_date">
            </div>
            <div class="form-group">
                <label>終了日</label>
                <input type="date" id="end_date">
            </div>
        </div>
        <div class="form-group">
            <label>会場</label>
            <input type="text" id="venue" placeholder="例：○○体育館">
        </div>
        <button class="btn-save" id="btn-save-basic" onclick="saveBasicInfo()">基本情報を保存</button>
    </div>

    <div class="card">
        <h2>クラス管理</h2>

        <div class="type-section">
            <div class="type-header">
                <span class="type-badge individual">個人</span>
            </div>
            <div id="individual-list" class="class-list"></div>
            <button class="btn-add" onclick="addToType('individual')">＋ 個人クラスを追加</button>
        </div>

        <div class="type-section" style="margin-top:24px;">
            <div class="type-header">
                <span class="type-badge synchro">シンクロ</span>
            </div>
            <div id="synchro-list" class="class-list"></div>
            <button class="btn-add" onclick="addToType('synchro')">＋ シンクロクラスを追加</button>
        </div>

        <button class="btn-save" id="btn-save-classes" style="margin-top:20px;" onclick="saveClasses()">クラスを保存</button>
    </div>

    <div class="danger-zone">
        <h2>⚠️ 危険な操作</h2>
        <p>大会を削除すると、すべてのデータが失われます。この操作は取り消せません。</p>
        <button class="btn-danger" onclick="deleteTournament()">この大会を削除する</button>
    </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
    import { getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ensureAdmin, logout } from './auth.js';

    // auth.js がすでに Firebase を初期化しているので getApp() で取得
    const db = getFirestore(getApp());

    const params = new URLSearchParams(location.search);
    const eventId = params.get('event');

    // クラスのローカル状態（個人／シンクロ別）
    let individual = [];
    let synchro    = [];

    ensureAdmin(user => {
        document.getElementById('auth-info').style.display = 'flex';
        document.getElementById('user-name').textContent = user.displayName || user.email;
        document.getElementById('logout-btn').onclick = logout;
        initPage();
    });

    async function initPage() {
        if (!eventId) { location.href = 'admin_index.html'; return; }
        document.getElementById('back-link').href = `admin_menu.html?event=${eventId}`;

        const tDoc = await getDoc(doc(db, 'tournaments', eventId));
        if (!tDoc.exists()) { showToast('大会データが見つかりません', true); return; }

        const d = tDoc.data();
        document.getElementById('name').value = d.name || '';
        document.getElementById('start_date').value = d.start_date || d.startDate || '';
        document.getElementById('end_date').value = d.end_date || d.endDate || '';
        document.getElementById('venue').value = d.venue || '';

        const normalize = arr => (arr || [])
            .map((c, i) => ({ name: c.name || '', display_order: c.display_order ?? i }))
            .sort((a, b) => a.display_order - b.display_order);

        const rulesKeys = obj => Object.keys(obj || {}).map((name, i) => ({ name, display_order: i }));

        if (d.classes && !Array.isArray(d.classes) && (d.classes.individual || d.classes.synchro)) {
            // 新形式: { individual: [...], synchro: [...] }
            individual = normalize(d.classes.individual);
            synchro    = normalize(d.classes.synchro);
            // シンクロが未保存でも classRules にデータがあれば補完
            if (synchro.length === 0 && d.classRules?.synchro) {
                synchro = rulesKeys(d.classRules.synchro);
            }
        } else if (Array.isArray(d.classes) && d.classes.length > 0) {
            // 旧フラット配列: すべて個人として移行し、classRules からシンクロも補完
            individual = normalize(d.classes);
            synchro    = d.classRules?.synchro ? rulesKeys(d.classRules.synchro) : [];
            showToast('既存クラスを個人クラスとして読み込みました');
        } else if (d.classRules) {
            // 最旧形式: classRules のキーから抽出
            individual = rulesKeys(d.classRules.individual);
            synchro    = rulesKeys(d.classRules.synchro);
            const total = individual.length + synchro.length;
            if (total > 0) showToast(`classRulesから${total}件のクラスを読み込みました`);
        }

        renderAll();
    }

    function renderAll() {
        renderList('individual-list', individual, 'individual');
        renderList('synchro-list',    synchro,    'synchro');
    }

    function renderList(listId, arr, type) {
        const list = document.getElementById(listId);
        list.innerHTML = '';
        arr.forEach((cls, i) => {
            const div = document.createElement('div');
            div.className = 'class-item';

            const input = document.createElement('input');
            input.type = 'text';
            input.value = cls.name;
            input.placeholder = 'クラス名（例：Aクラス）';
            input.addEventListener('input', e => { arr[i].name = e.target.value; });

            const btnUp   = mkBtn('▲', '上へ',  i === 0,            () => { moveItem(arr, i, -1); renderList(listId, arr, type); });
            const btnDown = mkBtn('▼', '下へ',  i === arr.length-1, () => { moveItem(arr, i,  1); renderList(listId, arr, type); });
            const btnDel  = mkBtn('✕', '削除', false, () => {
                if (!confirm(`クラス「${arr[i].name || '（名前なし）'}」を削除しますか？`)) return;
                arr.splice(i, 1);
                renderList(listId, arr, type);
            }, true);

            div.append(input, btnUp, btnDown, btnDel);
            list.appendChild(div);
        });
    }

    function mkBtn(text, title, disabled, onclick, isDanger = false) {
        const btn = document.createElement('button');
        btn.className = 'btn-icon' + (isDanger ? ' danger' : '');
        btn.title = title;
        btn.textContent = text;
        btn.disabled = disabled;
        btn.onclick = onclick;
        return btn;
    }

    function moveItem(arr, i, dir) {
        const t = i + dir;
        if (t < 0 || t >= arr.length) return;
        [arr[i], arr[t]] = [arr[t], arr[i]];
    }

    window.addToType = (type) => {
        const arr = type === 'individual' ? individual : synchro;
        const listId = type === 'individual' ? 'individual-list' : 'synchro-list';
        arr.push({ name: '', display_order: arr.length });
        renderList(listId, arr, type);
        const inputs = document.querySelectorAll(`#${listId} .class-item input`);
        if (inputs.length) inputs[inputs.length - 1].focus();
    };

    window.saveBasicInfo = async () => {
        const name = document.getElementById('name').value.trim();
        if (!name) { showToast('大会名を入力してください', true); return; }

        const btn = document.getElementById('btn-save-basic');
        btn.disabled = true;
        btn.textContent = '保存中…';
        try {
            await setDoc(doc(db, 'tournaments', eventId), {
                name,
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                venue: document.getElementById('venue').value.trim(),
                updatedAt: serverTimestamp()
            }, { merge: true });
            showToast('基本情報を保存しました');
        } catch (e) {
            showToast('保存に失敗しました: ' + e.message, true);
        } finally {
            btn.disabled = false;
            btn.textContent = '基本情報を保存';
        }
    };

    window.saveClasses = async () => {
        const allClasses = [...individual, ...synchro];
        if (allClasses.some(c => !c.name.trim())) {
            showToast('クラス名を入力してください', true);
            return;
        }

        const btn = document.getElementById('btn-save-classes');
        btn.disabled = true;
        btn.textContent = '保存中…';
        try {
            const toPayload = arr => arr.map((c, i) => ({ name: c.name.trim(), display_order: i }));
            const payload = { individual: toPayload(individual), synchro: toPayload(synchro) };
            await setDoc(doc(db, 'tournaments', eventId), { classes: payload }, { merge: true });
            individual = payload.individual;
            synchro    = payload.synchro;
            showToast('クラスを保存しました');
            renderAll();
        } catch (e) {
            showToast('保存に失敗しました: ' + e.message, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'クラスを保存';
        }
    };

    window.deleteTournament = async () => {
        const name = document.getElementById('name').value.trim() || '（名前未設定）';
        if (!confirm(`大会「${name}」を削除しますか？\nすべてのデータが失われます。`)) return;
        if (!confirm('本当に削除しますか？この操作は取り消せません。')) return;
        try {
            // athletes サブコレクションも削除
            const athSnap = await getDocs(collection(db, 'tournaments', eventId, 'athletes'));
            const batch = writeBatch(db);
            athSnap.docs.forEach(d => batch.delete(d.ref));
            batch.delete(doc(db, 'tournaments', eventId));
            await batch.commit();
            showToast('大会を削除しました');
            setTimeout(() => { location.href = 'admin_index.html'; }, 1500);
        } catch (e) {
            showToast('削除に失敗しました: ' + e.message, true);
        }
    };

    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast' + (isError ? ' error' : '');
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
</script>
</body>
</html>
